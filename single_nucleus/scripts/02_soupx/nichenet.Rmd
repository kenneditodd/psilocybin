---
title: "Psi1 snRNAseq"
subtitle: "NicheNet"
author: "Kennedi Todd"
date: "11/17/2025"
output:
  html_document:
    theme: cerulean
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: inline
---

# Setup
## Working directory
```{r working_directory}
knitr::opts_knit$set(root.dir = ".")
```

## Libraries
```{r libraries, message=FALSE, warning=FALSE}
library(nichenetr)      # get_expressed_genes()
library(Seurat)         # DimPlot()
```

## Load data
```{r load_data}
mouse_annotated <- readRDS("../../rObjects/pass4_downsampled_annotated_seurat_obj.rds")
```

## UMAP
```{r umap}
cluster_colors <- c("#cc79a7","#d55c00","#000","#0072b2","#009e73","#56b4df",
                    "#e69f00", "#f0e442")

DimPlot(
  object = mouse_annotated,
  cols = cluster_colors
)
```

# NicheNet
## Read in network
Read in the ligand-receptor network, ligand-target prior model, and weighted integrated networks.
```{r nn_refs}
# ligand-receptor network
nn_lr_network <- 
  readRDS(url("https://zenodo.org/record/7074291/files/lr_network_mouse_21122021.rds"))

# ligand-target prior model
nn_ligand_target_matrix <- 
  readRDS(url("https://zenodo.org/record/7074291/files/ligand_target_matrix_nsga2r_final_mouse.rds"))

# weighted integrated networks
nn_weighted_networks <- 
  readRDS(url("https://zenodo.org/record/7074291/files/weighted_networks_nsga2r_final_mouse.rds"))
```

## User input
- Sender cells = cells that express ligands \
- Receiver cells = cells that express the receptors \
```{r nn_user_input}
# user defined variables
out <- "../../results/pass4_downsampled/nichenet/"
groups <- c("E4CF","E3CF")
myReceiver <- "Astrocytes"
mySenders <- c("Macrophages","LECs","B cells","T and NK cells")
receiverOut <- "receiver_BECs"
senderOut <- "/sender_macro_lecs_b_t_nk_cells"
lfc_thresh <- 0.5

# get color map
cm <- data.frame(cell_types = levels(mouse.annotated$annotated_clusters),
                 colors = cluster_colors)
cm <- cm[cm$cell_types %in% c(myReceiver,mySenders),]

# initialize log file
log_path <- paste0(out, "nichenet/", groups[1], "_vs_", groups[2], "/", 
                   receiverOut, senderOut, "/log.txt")
cat("NicheNet Analysis\n", file = log_path, sep = "\n", append = FALSE)

# write user input to log
msg <- c("Comparison of interest:", paste0("\t", groups[1], " vs. ", groups[2]),
         "Receiver:", paste0("\t", myReceiver),
         "Senders:", paste0("\t", mySenders))
cat(msg, file = log_path, append = TRUE, sep = "\n")

# filter seurat obj based on cell types of interest
mouse.nn <- subset(mouse.annotated, annotated_clusters %in% c(mySenders, myReceiver))
mouse.nn <- subset(mouse.nn, group %in% groups[1])

# get distribution of cell types and groups
df <- mouse.nn@meta.data %>% count(annotated_clusters, group, name = "Count")
df <- knitr::kable(df, format = "simple")

# write to log
msg <- c("", "Filtering cells", "", "\t\tCELL NUMBER DISTRIBUTION", df)
cat(msg, file = log_path, append = TRUE, sep = "\n")

# reset params
mouse.nn$annotated_clusters <- as.character(mouse.nn$annotated_clusters)
mouse.nn$group <- as.character(mouse.nn$group)
Idents(mouse.nn) <- "annotated_clusters"
```

## Gene set of interest
- The gene set of interest is usually DEGs but since we have low/none for LECs we will use genes with a avg_log2FC > +thresh.
```{r nn_goi}
# define gene set of interest 
# rows = target genes in the ligand target matrix
path <- paste0(out, "DEGs/DEG_tables/", groups[1], "_vs_", groups[2], "_DEGs.tsv")
goi <- read.table(file = path, sep = "\t", header = TRUE)
goi <- goi[goi$cluster == myReceiver,]
goi <- goi[goi$avg_log2FC > lfc_thresh,]
goi <- goi$gene
goi <- goi %>% .[. %in% rownames(nn_ligand_target_matrix)]

# print message
msg <- paste0("There are ", length(goi), " genes with a avg_log2FC > ", lfc_thresh)
print(msg)
cat(c("", "Getting gene set of interest", paste0("\t", msg)), 
    file = log_path, append = TRUE, sep = "\n")
```

## Sender-agnostic ligands
Given receptors expressed in receiver cell population, get all associated ligands.
```{r sender_agnostic}
# print receiver cell pop
paste("receiver cell population =", myReceiver)

# determine all genes expressed in receiver cell population
all_genes_receiver <- get_expressed_genes(myReceiver, mouse.nn)
msg <- paste(length(all_genes_receiver), "genes expressed in the receiver cell population.")
print(msg)
cat(c("", "Sender-agnostic info", paste0("\t", msg)), 
    file = log_path, append = TRUE, sep = "\n")

# define expressed receptors in the receiver cell population
all_receptors_receiver <- intersect(unique(nn_lr_network$to), all_genes_receiver)
msg <- paste(length(all_receptors_receiver), "receptors expressed in receiver cell population.")
print(msg)
cat(paste0("\t", msg), file = log_path, append = TRUE, sep = "\n")

# define potential ligands given expressed receptors
potential_ligands_sender_agnostic <- nn_lr_network %>% 
  filter(to %in% all_receptors_receiver) %>% 
  pull(from) %>% 
  unique()
msg <- paste("There are", length(potential_ligands_sender_agnostic), 
            "potential ligands in the sender-agnostic approach.")
print(msg)
cat(paste0("\t", msg), file = log_path, append = TRUE, sep = "\n")

# cleanup
remove(all_receptors_receiver)
```

## Sender-focused ligands
```{r sender_focused_ligands}
# get all sender cell populations
print("My sender cell types:")
print(mySenders)

# get all the expressed genes of every sender cell type separately
list_all_genes_sender <- 
  mySenders %>% 
  unique() %>% 
  lapply(get_expressed_genes, mouse.nn)
all_ligands_sender <- 
  list_all_genes_sender %>% 
  unlist() %>% 
  unique()

# display message
msg <- paste(length(all_ligands_sender), "expressed ligands from sender cell types.")
print(msg)
cat(c("", "Sender-focused info", paste0("\t", msg)),
    file = log_path, append = TRUE, sep = "\n")

# get ligands expressed in sender cell types
potential_ligands_sender_focused <- 
  intersect(potential_ligands_sender_agnostic, all_ligands_sender)

# view how many
msg <- paste(length(potential_ligands_sender_focused),
             "sender-focused ligands intersect sender-agnostic ligands.")
print(msg)
cat(paste0("\t", msg), file = log_path, append = TRUE, sep = "\n")

# cleanup
remove(list_all_genes_sender, all_ligands_sender, potential_ligands_sender_agnostic)
```

## Ligand activity
Given a gene set of interest (usually DEGs), all expressed genes in the receiver cell population, the NicheNet ligand-target matrix, and potential ligands using the sender-agnostic approach, predict activities of ligands regulating expression in the gene set of interest. AUPR (Area Under the Precision-Recall curve) integrates precision and recall into a single value, emphasizing performance on the positive class, making it suitable for unbalanced data sets like ligand-target interactions. Precision measures the proportion of true-positives to (true-positives + false-positives). Recall measures the proportion of true-positives to (true-positives + false-negatives).
```{r ligand_activity}
# define background genes
background_genes <- all_genes_receiver %>% .[. %in% rownames(nn_ligand_target_matrix)]
background_genes <- background_genes[!background_genes %in% goi]
msg <- paste("\n", length(background_genes), "background genes. Background genes are",
             "receiver expressed genes that are in the NicheNet ligand-target",
             "matrix and NOT in the gene set of interest")
print(msg)
cat(paste0("", msg), file = log_path, append = TRUE, sep = "\n")

# get ligand activity
ligand_activities_sender_focused <- predict_ligand_activities(
  geneset = goi,
  background_expressed_genes = background_genes,
  ligand_target_matrix = nn_ligand_target_matrix,
  potential_ligands = potential_ligands_sender_focused)

# reorder table
ligand_activities_sender_focused <- 
  ligand_activities_sender_focused %>% 
  arrange(-aupr_corrected) %>% 
  mutate(rank = rank(-aupr_corrected, ties.method = "first"))

# save output
write.table(x = ligand_activities_sender_focused,
            file = paste0(out, "nichenet/", groups[1], "_vs_", groups[2], "/",
                          receiverOut, senderOut, "/sender_focused_ligand_activity.tsv"),
            sep = "\t",
            quote = FALSE,
            row.names = FALSE)

# save top 35 ligands
best_sender_focused_ligands <- 
  ligand_activities_sender_focused %>% 
  arrange(-aupr_corrected) %>% 
  top_n(35, aupr_corrected) %>% 
  pull(test_ligand)

# cleanup
remove(all_genes_receiver, background_genes, potential_ligands_sender_focused,
       ligand_activities_sender_focused)
```

## Ligand target links
Infer ligand downstream gene targets
```{r ligand_target_links}
ligand_target_links_df <- 
  best_sender_focused_ligands %>%
  lapply(get_weighted_ligand_target_links,
         geneset = goi,
         ligand_target_matrix = nn_ligand_target_matrix) %>%
  bind_rows() %>% drop_na()
```

## Circos plot
```{r circos_plot, warning=FALSE}
# Subset seurat obj
mouse.nn.sender <- subset(mouse.nn, annotated_clusters == mySenders)
table(mouse.nn.sender$annotated_clusters)
DefaultAssay(mouse.nn.sender) <- "RNA"
Idents(mouse.nn.sender) <- "annotated_clusters"

# Assign ligands to cell types
ligand_type_indication_df <- assign_ligands_to_celltype(
  seuratObj = mouse.nn.sender,
  ligands = best_sender_focused_ligands,
  celltype_col = "annotated_clusters"
)

# Generate circos_links using get_ligand_target_links_oi
circos_links <- get_ligand_target_links_oi(
  ligand_type_indication_df = ligand_type_indication_df,
  active_ligand_target_links_df = ligand_target_links_df %>% mutate(target_type = myReceiver)
)

# Get ligand colors
ligand_colors <- ""
if("General" %in% circos_links$ligand_type) {
  subset_cm <- cm[cm$cell_types %in% mySenders,]
  subset_cm <- rbind(subset_cm, c("General","black"))
  ligand_colors <- subset_cm$colors
  names(ligand_colors) <- subset_cm$cell_types
  # update cm too
  if (!"Common ligands" %in% cm$cell_types) {
    cm <- rbind(cm, c("Common ligands", "black"))}
} else {
  subset_cm <- cm[cm$cell_types %in% mySenders,]
  ligand_colors <- subset_cm$colors
  names(ligand_colors) <- subset_cm$cell_types
}

# Get target colors
subset_cm <- cm[cm$cell_types %in% myReceiver,]
target_colors <- subset_cm$colors
names(target_colors) <- subset_cm$cell_types

# Prepare the visualization object using prepare_circos_visualization
vis_circos_obj <- prepare_circos_visualization(
  circos_links = circos_links,
  ligand_colors = ligand_colors,
  target_colors = target_colors,
  widths = NULL,
  celltype_order = NULL
)

# Create target genes legend
target_legend <- Legend(
  labels = names(target_colors),
  background = target_colors,
  type = "rect",
  grid_height = unit(3, "mm"),
  grid_width = unit(3, "mm"),
  labels_gp = gpar(fontsize = 14),
  title = "Target genes",
  title_gp = gpar(fontsize = 14)
)

# Create ligand genes legend
ligand_legend <- Legend(
  labels = gsub("General", "Common ligands", names(ligand_colors)),
  background = ligand_colors,
  type = "rect",
  grid_height = unit(3, "mm"),
  grid_width = unit(3, "mm"),
  labels_gp = gpar(fontsize = 14),
  title = "Ligand genes",
  title_gp = gpar(fontsize = 14)
)

# Combine the two legends
combined_legend <- packLegend(target_legend, ligand_legend, direction = "vertical")

# plot circos
make_circos_plot(
  vis_circos_obj,
  transparency = TRUE, 
  args.circos.text = list(cex = 0.5)  # Increase default font size slightly
)

# generate and store the updated circos plot before saving
circos_no_legend <- recordPlot()

# Save to PDF
path <- paste0(out, "nichenet/", groups[1], "_vs_", groups[2], "/", receiverOut, 
               senderOut, "/sender_focused_ligand_target_circos_plot.pdf")
pdf(path, height = 10, width = 14)
# Draw Circos plot directly inside the PDF
make_circos_plot(vis_circos_obj, transparency = TRUE, args.circos.text = list(cex = 0.5))
# Convert the legend into a grob
legend_grob <- grid.grabExpr(draw(combined_legend))
# Move legend to the right
grid::pushViewport(grid::viewport(x = 0.8, y = 0.5, width = 0.2, height = 1, just = c("left", "center")))
grid.draw(legend_grob)
grid::popViewport()
dev.off()

# Save to SVG
path <- paste0(out, "nichenet/", groups[1], "_vs_", groups[2], "/", receiverOut, 
               senderOut, "/sender_focused_ligand_target_circos_plot.svg")
svg(path, height = 10, width = 14)
# Draw Circos plot directly inside the PDF
make_circos_plot(vis_circos_obj, transparency = TRUE, args.circos.text = list(cex = 0.5))
# Convert the legend into a grob
legend_grob <- grid.grabExpr(draw(combined_legend))
# Move legend to the right
grid::pushViewport(grid::viewport(x = 0.8, y = 0.5, width = 0.2, height = 1, just = c("left", "center")))
grid.draw(legend_grob)
grid::popViewport()
dev.off()
```

## Dot plot
```{r dot_plot}
# save
path <- paste0(out, "nichenet/", groups[1], "_vs_", groups[2], "/", receiverOut, 
               senderOut, "/sender_focused_dot_plot.pdf")
pdf(path, height = 8, width = 10)

# dot plot
DotPlot(mouse.nn.sender,
        features = rev(best_sender_focused_ligands), 
        assay = "RNA",
        group.by = "annotated_clusters",
        cols = "RdYlBu") + 
  labs(x = "Top Ranked Ligands", y = "Sender Cell Populations") +
  coord_flip() +
  scale_y_discrete(position = "right") +
  theme(axis.text.x = element_text(angle = 45, hjust = 0))
```

# UMAP Heatmap
## Subset
```{r subset_clusters}
# subset object to clusters of interest
mouse.annotated$subset_cells <- 
  mouse.annotated$annotated_clusters %in% c("Macrophages","Fibroblasts", "Mast cells",
                                            "Pericytes and SMCs", "BECs")
obj <- subset(mouse.annotated, subset_cells == TRUE)

# check
table(obj$annotated_clusters)
```

## Plot 1
```{r dot1}
# reset sample levels
obj$sample <- factor(obj$sample, levels = c("E3CF1","E3CF2","E3CM1","E3CM2",
                                            "E4CF1","E4CF2","E4CM1","E4CM2",
                                            "E3PF1","E3PF2","E3PM1","E3PM2",
                                            "E4PF1","E4PF2","E4PM1","E4PM2"))

# dot plot
dot <- DotPlot(
  object = obj,
  features = c("Pecam1","Pdgfrb","Ms4a2","Col1a2","Mrc1","Apoe"),
  group.by = "annotated_clusters",
  split.by = "sample",
  assay = "RNA",
  cols = "RdYlBu",) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Reset plot levels
clusters <- c("Macrophages","Fibroblasts","Mast cells", "Pericytes and SMCs", 
              "BECs")
samples <- levels(obj$sample)
combined_levels <- expand.grid(samples, clusters)
combined_levels$combined <- paste(combined_levels$Var2, combined_levels$Var1, 
                                  sep = "_")
combined_levels <- combined_levels$combined
dot$data$id <- factor(dot$data$id, levels = combined_levels)

# replot
dot
```

## Plot 2
```{r}
dot2 <- dot

dot2$data$cluster <- stringr::str_match(
  string = dot2$data$id, pattern = "(.+)_.+"
)[,2]

dot2 <- 
  dot2 + 
  facet_wrap(~ cluster, scales = "free_y")

dot2$data$cluster <- factor(dot2$data$cluster,
                            levels = clusters)

dot2
```

## Plot 3
```{r}
dot3 <- dot

dot3$data$cluster <- stringr::str_match(
  string = dot3$data$id, pattern = "(.+)_.+"
)[,2]

dot3$data$sample <- stringr::str_match(
  string = dot3$data$id, pattern = ".+_(.+)"
)[,2]

# set sample as id
dot3$data$id <- dot3$data$sample
dot3$data$id <- factor(dot3$data$sample, levels = levels(obj$sample))

# reset cluster levels
dot3$data$cluster <- factor(dot3$data$cluster,
                            levels = clusters)

dot3 <- 
  dot3 + 
  facet_wrap(~ cluster, scales = "free_y")
dot3
```

